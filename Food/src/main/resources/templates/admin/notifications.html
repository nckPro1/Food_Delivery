<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Thông báo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .notification-card {
      border-left: 4px solid #007bff;
      margin-bottom: 10px;
      animation: slideIn 0.3s ease-out;
    }

    .notification-card.new-order {
      border-left-color: #28a745;
    }

    .notification-card.status-update {
      border-left-color: #ffc107;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .notification-badge {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    .sound-indicator {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
    }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
      <div class="position-sticky pt-3">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link" href="/admin/dashboard">
              <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/admin/notifications">
              <i class="fas fa-bell"></i> Thông báo
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/orders">
              <i class="fas fa-shopping-cart"></i> Đơn hàng
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/products">
              <i class="fas fa-box"></i> Sản phẩm
            </a>
          </li>
        </ul>
      </div>
    </div>

    <!-- Main content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Thông báo Real-time</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
          <button class="btn btn-sm btn-outline-secondary" onclick="clearNotifications()">
            <i class="fas fa-trash"></i> Xóa tất cả
          </button>
          <button class="btn btn-sm btn-outline-secondary" onclick="toggleSound()">
            <i class="fas fa-volume-up" id="soundIcon"></i> <span id="soundText">Bật âm thanh</span>
          </button>
        </div>
      </div>

      <!-- Connection Status -->
      <div class="alert alert-info" id="connectionStatus">
        <i class="fas fa-wifi"></i> Đang kết nối...
      </div>

      <!-- Notifications Container -->
      <div id="notificationsContainer">
        <!-- Notifications will be added here dynamically -->
      </div>

      <!-- Empty state -->
      <div class="text-center py-5" id="emptyState" style="display: none;">
        <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">Chưa có thông báo nào</h4>
        <p class="text-muted">Các thông báo về đơn hàng mới sẽ xuất hiện ở đây</p>
      </div>
    </main>
  </div>
</div>

<!-- Notification Badge -->
<div class="notification-badge">
  <span class="badge bg-danger" id="notificationCount" style="display: none;">0</span>
</div>

<!-- Sound Indicator -->
<div class="sound-indicator">
  <div class="alert alert-success" id="soundIndicator" style="display: none;">
    <i class="fas fa-volume-up"></i> Âm thanh đã bật
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
  let stompClient = null;
  let notificationCount = 0;
  let soundEnabled = false;

  // Initialize WebSocket connection
  function connect() {
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);

    stompClient.connect({}, function(frame) {
      console.log('Connected: ' + frame);
      updateConnectionStatus(true);

      // Subscribe to admin notifications
      stompClient.subscribe('/topic/admin/orders', function(notification) {
        const data = JSON.parse(notification.body);
        addNotification(data);
      });
    }, function(error) {
      console.log('Connection error: ' + error);
      updateConnectionStatus(false);
      // Retry connection after 5 seconds
      setTimeout(connect, 5000);
    });
  }

  function updateConnectionStatus(connected) {
    const statusEl = document.getElementById('connectionStatus');
    if (connected) {
      statusEl.className = 'alert alert-success';
      statusEl.innerHTML = '<i class="fas fa-wifi"></i> Đã kết nối';
    } else {
      statusEl.className = 'alert alert-danger';
      statusEl.innerHTML = '<i class="fas fa-wifi"></i> Mất kết nối - Đang thử kết nối lại...';
    }
  }

  function addNotification(notification) {
    notificationCount++;
    updateNotificationCount();

    // Play sound if enabled
    if (soundEnabled) {
      playNotificationSound();
    }

    // Show sound indicator
    if (soundEnabled) {
      showSoundIndicator();
    }

    // Create notification card
    const notificationCard = createNotificationCard(notification);

    // Add to container
    const container = document.getElementById('notificationsContainer');
    const emptyState = document.getElementById('emptyState');

    if (emptyState.style.display !== 'none') {
      emptyState.style.display = 'none';
    }

    container.insertBefore(notificationCard, container.firstChild);

    // Auto remove after 30 seconds
    setTimeout(() => {
      notificationCard.remove();
      notificationCount--;
      updateNotificationCount();

      // Show empty state if no notifications
      if (notificationCount === 0) {
        emptyState.style.display = 'block';
      }
    }, 30000);
  }

  function createNotificationCard(notification) {
    const card = document.createElement('div');
    card.className = 'card notification-card ' + (notification.type === 'NEW_ORDER' ? 'new-order' : 'status-update');

    const icon = notification.type === 'NEW_ORDER' ? 'fas fa-shopping-cart' : 'fas fa-sync-alt';
    const title = notification.type === 'NEW_ORDER' ? 'Đơn hàng mới' : 'Cập nhật trạng thái';

    card.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title">
                                <i class="${icon}"></i> ${title}
                            </h6>
                            <p class="card-text">${notification.message}</p>
                            <small class="text-muted">
                                <i class="fas fa-clock"></i> ${new Date(notification.timestamp).toLocaleString('vi-VN')}
                            </small>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="this.parentElement.parentElement.parentElement.remove(); notificationCount--; updateNotificationCount();">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;

    return card;
  }

  function updateNotificationCount() {
    const countEl = document.getElementById('notificationCount');
    if (notificationCount > 0) {
      countEl.textContent = notificationCount;
      countEl.style.display = 'inline-block';
    } else {
      countEl.style.display = 'none';
    }
  }

  function playNotificationSound() {
    // Create audio element and play notification sound
    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
    audio.play().catch(e => console.log('Could not play sound:', e));
  }

  function showSoundIndicator() {
    const indicator = document.getElementById('soundIndicator');
    indicator.style.display = 'block';
    setTimeout(() => {
      indicator.style.display = 'none';
    }, 2000);
  }

  function toggleSound() {
    soundEnabled = !soundEnabled;
    const icon = document.getElementById('soundIcon');
    const text = document.getElementById('soundText');

    if (soundEnabled) {
      icon.className = 'fas fa-volume-up';
      text.textContent = 'Tắt âm thanh';
    } else {
      icon.className = 'fas fa-volume-mute';
      text.textContent = 'Bật âm thanh';
    }
  }

  function clearNotifications() {
    document.getElementById('notificationsContainer').innerHTML = '';
    notificationCount = 0;
    updateNotificationCount();
    document.getElementById('emptyState').style.display = 'block';
  }

  // Initialize when page loads
  document.addEventListener('DOMContentLoaded', function() {
    connect();
  });
</script>
</body>
</html>
